<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
</head>
<body>
	<canvas id="canvas">流星与星星</canvas>
</body>
</html>
<script src="js/utils.js"></script>
<script type="text/javascript">
	var canvas = document.getElementById('canvas');
	canvas.style.background = '#000';
	var W = canvas.width = window.innerWidth,
		H = canvas.height = window.innerHeight;
	var ctx = canvas.getContext('2d');

	var during = 0.05,
		starts = [];
	
	//星星半径的变化
	function randomInt(min, max) {
		return min + Math.random()*(max - min + 1);
	}

	//构造月亮
	function Moon(x,y,r){
		if(x === undefined){x = 100}
		if(y === undefined){y = 100}
		this.x = x;
		this.y = y;
		this.drawMoon = function(){
			ctx.beginPath();
			var gradient = ctx.createRadialGradient(this.x,this.y,50,this.x,this.y,800);
			    gradient.addColorStop(0, 'rgb(255,255,255)');
		        gradient.addColorStop(0.01, 'rgb(70,70,80)');
		        gradient.addColorStop(0.2, 'rgb(40,40,50)');
		        gradient.addColorStop(0.4, 'rgb(20,20,30)');
		        gradient.addColorStop(1, 'rgb(0,0,10)');
		    ctx.fillStyle = gradient;
		    ctx.rect(0,0,W,H);
		    ctx.fill();
		}
	}
	var moon = new Moon(200,200);
	
	//星星的构造函数
	function Particle(x, y) {
		if(x === undefined) {x = 100}
		if(y === undefined) {y = 100}
		this.color = '#fff';		
		this.x = x;
		this.y = y;
		this.radius = 1;
		this.randomR = randomInt(Math.random()*1+0.3,Math.random()*1+0.4);
		this.dying = false;
		this.base = [x,y];

		this.drawParticle = function() {
			if(this.dying === false && this.radius < this.randomR){
				this.radius += during;
			}else {
				this.dying = true;
			}

			if(this.dying){
				this.radius -= during;
			}

			ctx.save();
			ctx.beginPath();
			ctx.fillStyle = this.color;
			ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
			ctx.fill();
			ctx.restore();

			if(this.radius < 1){
				this.x = this.base[0];
				this.y = this.base[1];
				this.dying = false;
			}
		}
	}	
    //创建200颗星星
	for(var i=0; i<150; i++){
		var x = Math.random()*W;
		var y = Math.random()*H;
		var start = new Particle(x,y);
		starts.push(start);
	}

	//创造流星
	function Metoer(x, y) {
		this.x = x;
		this.y = y;
		this.vx = 0;
		this.vy = 0;
		this.length = 0;
		this.draw = function() {
			ctx.save();
			var gra = ctx.createRadialGradient(this.x, this.y, 0, this.x,
				this.y, this.length); 
        	gra.addColorStop(0, 'rgba(255,255,255,1)');
        	gra.addColorStop(1, 'rgba(0,0,0,0)');
			ctx.fillStyle = gra;
			ctx.beginPath();
			ctx.arc(this.x, this.y, 1, Math.PI/4, Math.PI*5/4);
			ctx.lineTo(this.x+this.length, this.y-this.length);
			ctx.closePath();
			ctx.fill();
		}
	}

	var metoers = [];
	//每过一段随机时间生成流星
	function createMetoer(){
		var x = Math.random()*W;
		var y = 0;
		var metoer = new Metoer(x,y);
		metoer.length = Math.random()*100+200;
		metoer.vx = -(1+Math.random()*5);
		metoer.vy = Math.random()*2+2;
		metoers.push(metoer);
		setTimeout(()=>{
			createMetoer();
		},Math.random()*3000)
	}
	createMetoer();//

    //流星出界后清除
	function applyMetoer(metoer, index, arr) {
		metoer.x += metoer.vx;
		metoer.y += metoer.vy;
		metoer.draw();
		if(metoer.y>H + metoer.length || metoer.x+metoer.length<0){
			arr.splice(index, 1)
	    }
	}
	(function drawFrame(){
		window.requestAnimationFrame(drawFrame);
		ctx.clearRect(0,0,W,H);

		moon.drawMoon();

		metoers.forEach(applyMetoer);

		starts.forEach(function(start){
			start.drawParticle()
		});
	}())
</script>